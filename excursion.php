<?php
session_start();
if(!isset($_SESSION["user"])){
    header("Location: index.php");
}
include_once("formHandler/dbconnect.php");
?>
<!DOCTYPE html>
<html lang="fr">
<head>
    <?php include_once("template/head.html"); ?>
    <title>Hiking - Excursions</title>
</head>
<body id="excursion">

    <?php include_once("template/header.php");?>

    <main>
        <nav>
            <ul class="flex column">
                <li><a class="active" href="excursion.php"><svg fill="#ffeace" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="51.2" height="51.2" data-svg="camel"><path d="M80.648,73.146h-3.257c-4.143,0-7.5,3.357-7.5,7.5s3.357,7.5,7.5,7.5h3.257c4.143,0,7.5-3.357,7.5-7.5S84.791,73.146,80.648,73.146z"></path><path d="M509.804,291.026l-0.973-0.973c-3.126-3.125-4.848-7.281-4.848-11.701v-37.007c0-13.259-6.586-25.565-17.618-32.92l-7.09-4.726c-4.35-40.588-29.836-64.759-57.189-84.768c-14.133-10.338-23.367-20.868-31.514-30.159c-12.107-13.806-22.563-25.729-41.719-25.729c-16.407,0-22.371,10.479-26.726,18.131c-4.36,7.664-7.229,12.737-18.952,12.598c-8.155-0.088-11.607-5.258-17.008-14.389c-6.012-10.162-14.247-24.081-34.939-18.044c-17.256,5.032-26.912,30.21-38.094,59.363c-7.52,19.604-15.294,39.873-25.215,52.831c-3.432,4.481-15.871,19.104-31.872,19.104h-4.258c-13.545,0-24.564-11.02-24.564-24.564V82.238l13.334-11.112c2.897-2.415,3.551-6.606,1.525-9.788c-0.132-0.206-10.837-16.515-31.28-12.992H81.59c-8.426,0-16.349,3.281-22.309,9.24l-7.288,7.289l-25.632,4.271C11.087,71.693,0,84.78,0,100.266v3.677c0,8.556,6.961,15.516,15.517,15.516h55.961v61.969c0,24.423,12.293,48.432,33.728,65.868c22.316,18.155,53.028,28.161,86.477,28.176c0.347,0,0.705,0.187,0.705,0.498v149.328c-8.87,1.141-16.416,7.242-19.301,15.897l-4.362,13.086c-0.763,2.287-0.379,4.802,1.031,6.758c1.409,1.955,3.673,3.114,6.084,3.114h48.097c3.935,0,7.2-3.041,7.481-6.966l9.041-126.583c13.185,40.499,20.244,78.695,22.894,94.876c-8.354,1.509-15.364,7.446-18.121,15.715l-4.362,13.086c-0.763,2.287-0.379,4.802,1.031,6.758c1.409,1.955,3.673,3.114,6.084,3.114h48.098c2.096,0,4.096-0.877,5.516-2.418c1.42-1.542,2.131-3.606,1.959-5.695l-8.017-97.697c-0.035-0.437-0.109-0.869-0.221-1.293l-18.792-71.503c19.853-1.856,38.831-5.376,56.716-10.553c3.979-1.151,6.271-5.311,5.119-9.289c-1.151-3.979-5.312-6.272-9.289-5.119c-25.903,7.496-54.274,11.355-84.435,11.503l1.458-20.409c0.296-4.132-2.814-7.72-6.946-8.015c-4.119-0.317-7.721,2.814-8.015,6.946l-14.182,198.543h-30.707l1.071-3.215c1.163-3.489,4.415-5.834,8.094-5.834h4.477c4.143,0,7.5-3.357,7.5-7.5V275.969c0-8.542-7.042-15.494-15.699-15.498c-65.856-0.028-105.21-40.212-105.21-79.044v-69.469c0-4.143-3.357-7.5-7.5-7.5H15.517c-0.285,0-0.517-0.231-0.517-0.516v-3.677c0-8.123,5.815-14.987,13.828-16.322l28.002-4.667c1.542-0.258,2.965-0.99,4.07-2.096l8.987-8.988c3.126-3.125,7.282-4.847,11.702-4.847h9.584c0.176,0.586,0.418,1.161,0.748,1.709c2.135,3.55,6.743,4.695,10.293,2.563c10.766-6.473,18.006-5.155,22.334-2.675L108.41,78.39c-3.182,2.652-3.611,7.381-0.96,10.563c1.254,1.504,2.975,2.386,4.774,2.625v76.492c0,21.816,17.749,39.564,39.564,39.564h4.258c22.25,0,38.03-17.473,43.782-24.984c11.239-14.68,19.409-35.979,27.31-56.578c8.519-22.211,18.175-47.386,28.288-50.335c9.059-2.639,11.652,0.836,17.829,11.28c5.384,9.102,12.757,21.566,29.757,21.752c20.503,0.232,27.252-11.569,32.151-20.179c4.271-7.504,6.299-10.55,13.688-10.55c11.834,0,18.229,6.693,30.44,20.619c8.229,9.384,18.47,21.063,33.937,32.377c25.016,18.299,51.705,41.478,51.705,85.13v86.485c0,7.835,2.298,15.424,6.645,21.946l9.235,13.853l-7.381,110.7h-30.674l1.071-3.214c1.163-3.49,4.416-5.835,8.095-5.835h4.477c4.143,0,7.5-3.357,7.5-7.5v-72.146c0-1.255-0.314-2.489-0.916-3.592l-40.505-74.258c-4.701-8.621-8.165-17.85-10.294-27.431l-9.67-43.517c-0.898-4.043-4.898-6.595-8.948-5.694c-4.043,0.898-6.593,4.904-5.694,8.948l3.644,16.398c-4.669,3.519-15.203,10.737-31.642,18.075c-3.782,1.688-5.48,6.123-3.792,9.905c1.245,2.79,3.983,4.445,6.853,4.445c1.021,0,2.06-0.21,3.053-0.653c1.388-0.619,2.73-1.238,4.042-1.854c8.404,19.794,24.182,61.923,22.774,82.688c-2.122,31.292-16.37,68.531-21.549,81.19c-9.937,0.211-18.664,6.621-21.818,16.085l-4.362,13.086c-0.763,2.287-0.379,4.802,1.031,6.757c1.409,1.956,3.673,3.115,6.084,3.115h40.081c3.027,0,5.759-1.82,6.923-4.615l40.08-96.194c0.422-1.012,0.616-2.103,0.57-3.197l-0.783-15.814l9.839,18.038v62.927c-8.869,1.141-16.416,7.242-19.302,15.897l-4.362,13.086c-0.763,2.287-0.379,4.802,1.031,6.758c1.409,1.955,3.673,3.114,6.084,3.114h48.097c3.948,0,7.221-3.062,7.483-7.001l8.017-120.242c0.109-1.647-0.327-3.285-1.243-4.659l-10.646-15.97c-2.699-4.05-4.126-8.762-4.126-13.627V222.31c5.699,4.641,9.048,11.59,9.048,19.03v37.007c0,8.427,3.281,16.35,9.24,22.309l0.973,0.973c1.465,1.464,3.385,2.196,5.304,2.196c1.919,0,3.839-0.732,5.304-2.196C512.732,298.703,512.732,293.955,509.804,291.026z M243.566,287.089c5.977-0.009,11.892-0.159,17.738-0.45l19.34,73.586l7.297,88.928H258.39l1.071-3.214c1.163-3.49,4.416-5.835,8.095-5.835h4.477c2.162,0,4.22-0.934,5.644-2.561c1.425-1.628,2.077-3.791,1.79-5.935c-0.393-2.937-9.912-72.538-36.389-137.684L243.566,287.089z M387.274,449.153H362.6l1.071-3.215c1.163-3.489,4.415-5.834,8.094-5.834h4.478c2.968,0,5.656-1.75,6.857-4.464c0.894-2.017,21.904-49.867,24.673-90.707c0.9-13.271-3.279-33.339-12.422-59.646c-4.686-13.483-9.438-25.028-11.952-30.928c4.676-2.628,8.557-5.067,11.653-7.152l2.494,11.225c2.434,10.953,6.394,21.504,11.769,31.359l13.631,24.99l1.846,44.328L387.274,449.153z"></path></svg>Excursions</a></li>
                <li><a href="hiker.php"><svg fill="#ffeace" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="51.2" height="51.2" data-svg="hiker"><g stroke="black"><path stroke-width="10" d="M461.491,223.49c-0.803-24.393-21.39-43.49-45.796-43.49h-65.096l-40.016-60.024c0.312,0.005,0.62,0.024,0.933,0.024c34.035,0,61.542-28.485,59.933-62.867c-1.437-30.708-26.358-55.629-57.066-57.066c-34.381-1.61-62.867,25.897-62.867,59.932c0,11.137,3.06,21.568,8.369,30.516c-5.032,0.748-9.811,2.321-14.187,4.601c-5.231-7.417-12.72-13.278-21.776-16.484l-28.279-10.014c-23.446-8.303-49.137,3.951-57.44,27.397L112.97,167.27c-21.141-3.568-42.488,8.455-49.886,29.345l-10.014,28.28c-8.282,23.39,4.008,49.157,27.398,57.44l56.558,20.028c7.836,2.775,16.213,3.379,24.491,1.581v70.945c0,5.015-2.507,9.699-6.679,12.481l-63.28,42.185c-20.691,13.787-26.28,41.7-12.48,62.41c13.836,20.737,41.816,26.218,62.399,12.476l90-60c12.519-8.346,20.039-22.397,20.039-37.443v-49.183l30,15v93.387c0,25.18,20.606,46.222,45.782,45.791c24.454-0.419,44.218-20.442,44.218-44.993V344.999c0-17.158-9.534-32.583-24.881-40.256l-82.963-41.475l12.857-32.133l12.543,18.821c8.345,12.521,22.397,20.043,37.444,20.043h75v226.576c0,8.077,6.207,15.027,14.275,15.407c8.614,0.406,15.725-6.458,15.725-14.983v-229.58C449.422,261.068,462.156,243.692,461.491,223.49z M281.614,57.554c1.158-14.53,12.928-26.3,27.457-27.457c18.462-1.471,33.819,13.886,32.348,32.348c-1.158,14.529-12.928,26.299-27.457,27.457C295.5,91.373,280.143,76.016,281.614,57.554z M166.482,106.029c2.767-7.815,11.331-11.899,19.146-9.132l28.279,10.014c5.842,2.069,9.722,7.442,9.976,13.479l-29.932,74.829l-52.475-18.582L166.482,106.029z M147.039,274.083l-56.558-20.028c-7.797-2.761-11.894-11.35-9.133-19.147l10.014-28.279c2.761-7.797,11.353-11.893,19.146-9.133c5.807,2.056,66.492,23.546,72.292,25.6l-17.643,44.108C161.674,273.528,154.072,276.572,147.039,274.083z M221.516,406.998c0,5.027-2.497,9.693-6.68,12.481l-90.008,60.006c-6.888,4.598-16.208,2.705-20.79-4.163c-4.594-6.895-2.744-16.205,4.158-20.803l69.961-46.641c8.346-5.564,13.359-14.931,13.359-24.962v-55.102l30,15V406.998z M416.516,239.999h-90c-5.016,0-9.699-2.507-12.481-6.681l-28.357-42.551c-3.089-4.635-8.497-7.175-14.033-6.601c-5.541,0.576-10.306,4.176-12.375,9.347l-28.58,71.426c-2.898,7.244,0.24,15.5,7.219,18.989l95.311,47.648c5.085,2.542,8.296,7.738,8.296,13.423v121.565c0,8.067-6.187,15.019-14.244,15.416c-8.613,0.425-15.756-6.46-15.756-14.981V363.544c0-5.682-3.21-10.876-8.292-13.416l-103.418-51.709c-6.867-3.434-10.036-11.665-7.287-18.813c0-0.001,60.605-151.365,60.605-151.365c5.024-9.944,19.293-11.432,25.872-1.562l51.094,76.641c2.782,4.173,7.466,6.679,12.481,6.679h73.51c8.067,0,15.019,6.187,15.416,14.244C431.922,232.856,425.037,239.999,416.516,239.999z"></path></g></svg>Randonneurs</a></li>
                <li><a href="guide.php"><svg fill="#ffeace" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" width="51.2" height="51.2" data-svg="guide"><path d="m435.38 317.096c-14.337-2.294-59.157-9.467-73.38-11.743v-17.685c36.163-15.78 60-51.752 60-91.667v-41h50c5.522 0 10-4.478 10-10v-11.46c0-24.009-19.532-43.541-43.54-43.541h-16.958c-5.034-50.463-47.736-90-99.502-90s-94.468 39.537-99.501 90h-16.959c-24.008 0-43.54 19.532-43.54 43.54v11.46c0 5.522 4.477 10 10 10h50v41c0 39.917 23.839 75.89 60 91.668v17.685c-15.31 2.45-57.975 9.278-73.38 11.743-44.075 7.056-76.62 45.115-76.62 89.854v95.05c0 5.522 4.477 10 10 10h360c5.522 0 10-4.478 10-10v-95.05c0-44.636-32.442-82.782-76.62-89.854zm-113.38-297.096c40.724 0 74.413 30.594 79.353 70h-158.706c4.94-39.406 38.629-70 79.353-70zm-80 176v-41h36.001c5.522 0 10-4.478 10-10s-4.478-10-10-10c-10.308 0-83.83 0-96.001 0v-1.46c0-12.98 10.56-23.54 23.54-23.54h232.92c12.98 0 23.54 10.56 23.54 23.54v1.46c-9.646 0-83.472 0-93.999 0-5.522 0-10 4.478-10 10s4.478 10 10 10h33.999v41c0 43.716-35.387 80-80 80-44.61 0-80-36.281-80-80zm51.58 127.754c4.852-.776 8.42-4.961 8.42-9.874v-19.896c6.544 1.329 13.229 2.016 20 2.016s13.457-.687 20-2.016v19.896c0 4.913 3.568 9.098 8.42 9.874l33.189 5.311-61.609 82.148-61.609-82.148zm49.42 168.246h-41v-46h41zm-191-85.05c0-35.077 25.142-64.561 59.78-70.106l26.29-4.207 70.02 93.363h-16.09c-5.522 0-10 4.478-10 10v56h-70v-56c0-5.522-4.477-10-10-10s-10 4.478-10 10v56h-40zm340 85.05h-40v-56c0-5.522-4.478-10-10-10s-10 4.478-10 10v56h-69v-56c0-5.522-4.478-10-10-10h-17.09l70.02-93.363 26.289 4.207c34.639 5.546 59.781 35.029 59.781 70.106z"></path><path d="m356.627 216.005c2.765-4.781 1.129-10.898-3.652-13.662-4.781-2.765-10.898-1.129-13.662 3.652-3.568 6.171-10.202 10.005-17.313 10.005s-13.745-3.834-17.313-10.005c-2.763-4.779-8.878-6.418-13.662-3.652-4.781 2.764-6.417 8.881-3.652 13.662 7.13 12.333 20.398 19.995 34.627 19.995s27.497-7.662 34.627-19.995z"></path><path d="m10 492c-5.523 0-10 4.478-10 10s4.477 10 10 10h60c5.523 0 10-4.478 10-10s-4.477-10-10-10h-20v-163.229l143.714-57.486c3.797-1.519 6.286-5.196 6.286-9.285s-2.489-7.767-6.286-9.285l-143.714-57.486v-53.229c0-5.522-4.477-10-10-10s-10 4.478-10 10v350zm153.074-230-113.074 45.229v-90.458z"></path><circle cx="323" cy="145" r="10"></circle></svg>Guides</a></li>
            </ul>
        </nav>

        <section>
            <form id="create-form" class="excursion-form flex column">
                <div class="flex wrap evenly start">
                    <div class="flex column excursion-description">
                        <label>Nom de l'excursion</label>
                        <input type="text" name="name">
                        <div id="nameError" class="error"></div>
        
                        <label>Prix de l'excursion</label>
                        <input type="number" name="price">
                        <div id="priceError" class="error"></div>
        
                        <label>Nombre de places</label>
                        <input type="number" name="max_hikers">
                        <div id="maxHikersError" class="error"></div>
                    </div>
    
                    <div class="flex column excursion-description">
                        <label>Date de début</label>
                        <input type="date" name="departure_date">
            
                        <label>Date de fin</label>
                        <input type="date" name="arrival_date">
        
                        <div id="dateError" class="error"></div>
        
                        <?php
                        //fetch array of place name and id
                        $req = $pdo->query("SELECT id,name FROM place");
                        $places = $req->fetchAll();
                        $req -> closeCursor();
                        ?>
        
                        <label>Point de départ</label>
                        <select name="departure_place_id">
                            <?php
                            foreach($places as $place){
                            ?>
                                <option value="<?=$place['id']?>">
                                    <?=htmlspecialchars($place['name'])?>
                                </option>
                            <?php
                            }
                            ?>
                        </select>
            
                        <label>Point d'arrivée</label>
                        <select name="arrival_place_id">
                            <?php
                            foreach($places as $place){
                            ?>
                                <option value="<?=$place['id']?>">
                                    <?=htmlspecialchars($place['name'])?>
                                </option>
                            <?php
                            }
                            ?>
                        </select>
                        <div id="placeError" class="error"></div>
                    </div>

                    <div class="guides-list flex column">
                        <label>Guides</label>
                        <div class="flex column">
                            <?php
                            //fetch array of guide name and id
                            $req = $pdo->query("SELECT id,last_name,first_name FROM guide");
                            $guides = $req->fetchAll();
                            $req -> closeCursor();
                            foreach($guides as $guide){
                            ?>
                                <label class="custom-checkbox">
                                    <?=htmlspecialchars($guide['first_name'])?> <?=htmlspecialchars($guide['last_name'])?>
                                    <input type='checkbox' name='guide_ids[]' value='<?=$guide['id']?>'>
                                    <span></span>
                                </label>
                            <?php
                            }
                            ?>
                        </div>
                        <div id="guidesError" class="error"></div>
                    </div>
                </div>
                
                <input type="submit" value="Créer l'excursion">
            </form>

            <div id="excursions" class="flex wrap evenly">

            </div>
        </section>
    </main>

    <div id="update-modal" class="hidden modal flex center justify-center">
        <div class="flex column center">
            <button class="remove" onclick="hideModal()"></button>
            <form id="update-form" class="excursion-form flex column">
                <div class="flex wrap evenly start">
                    <div class="flex column excursion-description">
                        <label>Nom de l'excursion</label>
                        <input id="name-update" type="text" name="name">
                        <div id="update-nameError" class="error"></div>
        
                        <label>Prix de l'excursion</label>
                        <input id="price-update" type="number" name="price">
                        <div id="update-priceError" class="error"></div>
        
                        <label>Nombre de places</label>
                        <input id="maxHikers-update" type="number" name="max_hikers">
                        <div id="update-maxHikersError" class="error"></div>
                    </div>
    
                    <div class="flex column excursion-description">
                        <label>Date de début</label>
                        <input id="departureDate-update" type="date" name="departure_date">
            
                        <label>Date de fin</label>
                        <input id="arrivalDate-update" type="date" name="arrival_date">

                        <div id="update-dateError" class="error"></div>
                       
                        <?php
                        //fetch array of place name and id
                        $req = $pdo->query("SELECT id,name FROM place");
                        $places = $req->fetchAll();
                        $req -> closeCursor();
                        ?>
    
                        <label>Point de départ</label>
                        <select id="departurePlace-update" name="departure_place_id">
                            <?php
                            foreach($places as $place){
                            ?>
                                <option value="<?=$place['id']?>">
                                    <?=htmlspecialchars($place['name'])?>
                                </option>
                            <?php
                            }
                            ?>
                        </select>
            
                        <label>Point d'arrivée</label>
                        <select id="arrivalPlace-update" name="arrival_place_id">
                            <?php
                            foreach($places as $place){
                            ?>
                                <option value="<?=$place['id']?>">
                                    <?=htmlspecialchars($place['name'])?>
                                </option>
                            <?php
                            }
                            ?>
                        </select>
                        <div id="update-placeError" class="error"></div>
                    </div>

                    <div class="guides-list flex column">
                        <label>Guides</label>
                        <div class="flex column">
                            <?php
                            //fetch array of guide name and id
                            $req = $pdo->query("SELECT id,last_name,first_name FROM guide");
                            $guides = $req->fetchAll();
                            $req -> closeCursor();
                            foreach($guides as $guide){
                            ?>
                                <label class="custom-checkbox">
                                    <?=htmlspecialchars($guide['first_name'])?> <?=htmlspecialchars($guide['last_name'])?>
                                    <input type='checkbox' name='guide_ids[]' value='<?=$guide['id']?>'>
                                    <span></span>
                                </label>
                            <?php
                            }
                            ?>
                        </div>
                        <div id="update-guidesError" class="error"></div>
                    </div>
                </div>

                <input type="submit" value="Modifier">
                <div id="update-idError" class="error btn-error"></div>
            </form>
        </div>
    </div>

    <div id="delete-modal" class="hidden modal flex center justify-center">
        <div class="flex column center">
            <p>Êtes vous sûr de vouloir supprimer cette excursion?</p>
            <div>
                <button id="confirm"></button>
                <button id="decline" onclick="hideModal()"></button>
            </div>
        </div>
    </div>

    <script src="js/script.js"></script>
    <script src="js/excursion.js"></script>
</body>
</html>